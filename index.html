<!DOCTYPE html>

<html lang="ja">

<head>

<meta charset="UTF-8" />

<title>クイズ × キャラコレコレクション（完全版・PW対応）</title>

<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>

  :root{ --bg:#f7f7fb; --card:#ffffff; --ink:#222; --muted:#667; --brand:#4e6cf4; --ok:#2aa776; --warn:#e6a100; }

  *{box-sizing:border-box}

  body{margin:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Yu Gothic UI","Yu Gothic",Meiryo,sans-serif;background:var(--bg);color:var(--ink)}

  header{padding:16px 20px;background:var(--card);box-shadow:0 2px 10px rgba(0,0,0,.05);position:sticky;top:0;z-index:10}

  h1{font-size:20px;margin:0}

  .wrap{max-width:980px;margin:20px auto;padding:0 16px}

  .row{display:flex;flex-wrap:wrap;gap:12px}

  .card{background:var(--card);border-radius:16px;box-shadow:0 4px 16px rgba(0,0,0,.06);padding:16px}

  .login,.controls,.quiz,.collection,.teacher{width:100%}

  .login .row > *{flex:1}

  input[type="text"], input[type="password"], select{width:100%;padding:10px 12px;border:1px solid #ddd;border-radius:10px;font-size:16px;background:#fff}

  button{cursor:pointer;border:none;border-radius:12px;padding:10px 14px;font-weight:700}

  .btn{background:var(--brand);color:#fff}

  .btn.secondary{background:#e6e8ff;color:#2b2f7e}

  .btn.ghost{background:#eef0f7;color:#2b2f7e}

  .muted{color:var(--muted)}

  .quiz h2{margin:0 0 8px}

  .options{display:grid;gap:10px;margin-top:12px}

  .opt{padding:12px;border:2px solid #e7e7ee;border-radius:12px;background:#fff;text-align:left}

  .opt.correct{border-color:var(--ok)}

  .opt.wrong{border-color:#d33}

  .status{display:flex;align-items:center;gap:8px;margin-top:8px}

  .pill{padding:6px 10px;border-radius:999px;background:#eef0f7;font-size:12px}

  .result-area{margin-top:14px}

  .result-area img{max-width:160px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.12)}

  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:12px}

  .grid img{width:100%;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.12)}

  .split{display:grid;grid-template-columns:1.1fr .9fr;gap:12px}

  @media (max-width:900px){.split{grid-template-columns:1fr}}

  .progressbar{height:10px;background:#eef0f7;border-radius:999px;overflow:hidden}

  .progressbar > span{display:block;height:100%;background:linear-gradient(90deg,var(--ok),#67d6a7)}

  .small{font-size:12px}

  .badge{background:#fff3c2;color:#6b4b00;border:1px solid #ffe28a}

  .right{display:flex;gap:8px;align-items:center;justify-content:flex-end}

</style>

</head>

<body>



<header>

  <div class="wrap row" style="align-items:center;justify-content:space-between;">

    <h1>クイズ × キャラコレ（PW対応）</h1>

    <div class="right">

      <button class="btn ghost" id="teacherBtn">教師モード</button>

      <button class="btn secondary" id="showCollectionBtn">コレクション</button>

      <button class="btn ghost" id="logoutBtn" style="display:none">ログアウト</button>

    </div>

  </div>

</header>



<div class="wrap">

  <!-- Login -->

  <section class="card login" id="loginCard">

    <h2 style="margin:0 0 8px">ログイン</h2>

    <p class="muted small">ニックネーム＋パスワードでログイン。初回は新規登録になります。</p>

    <div class="row">

      <div><input id="nickname" type="text" autocomplete="username" placeholder="ニックネームを入力" /></div>

      <div><input id="password" type="password" autocomplete="current-password" placeholder="パスワード" /></div>

      <div style="flex:0 0 auto"><button class="btn" id="loginBtn">はじめる</button></div>

    </div>

    <p class="muted small" id="loginHelp" style="margin-top:8px">※ ブラウザのローカル保存のみ（学校PC共有の場合はご注意ください）</p>

  </section>



  <!-- Controls -->

  <section class="card controls" id="controlsCard" style="display:none">

    <div class="row">

      <div class="row" style="flex:1">

        <div style="flex:1">

          <label class="small muted">単元</label>

          <select id="unitSelect"></select>

        </div>

        <div style="flex:1">

          <label class="small muted">小単元</label>

          <select id="subunitSelect"></select>

        </div>

      </div>

      <div style="flex:0 0 auto;display:flex;gap:8px;align-items:flex-end">

        <button class="btn ghost" id="prevQ">← 前の問題</button>

        <button class="btn" id="nextQ">次の問題 →</button>

      </div>

    </div>

    <div class="row" style="margin-top:10px">

      <div style="flex:1">

        <div class="status">

          <span class="pill">ユーザー：<b id="currentUserLabel">-</b></span>

          <span class="pill">進捗：<span id="progressText">0/5</span></span>

          <span class="pill badge">初回正解でキャラGET！</span>

        </div>

        <div class="progressbar" style="margin-top:8px"><span id="progressBar" style="width:0%"></span></div>

      </div>

      <div style="flex:0 0 auto">

        <button class="btn secondary" id="resetSubunit">この小単元の進捗をリセット</button>

      </div>

    </div>

  </section>



  <div class="split">

    <!-- Quiz -->

    <section class="card quiz" id="quizCard" style="display:none">

      <h2 id="subunitTitle">-</h2>

      <div class="muted small" id="qCounter">1 / 5</div>

      <div id="questionText" style="margin-top:8px;font-size:18px;font-weight:600"></div>

      <div id="options" class="options"></div>

      <div id="feedback" class="result-area"></div>

    </section>



    <!-- Collection -->

    <section class="card collection" id="collectionCard" style="display:none">

      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">

        <h2 style="margin:0">コレクション</h2>

        <button class="btn ghost" id="hideCollectionBtn">閉じる</button>

      </div>

      <p class="muted small">コンプリートを目指そう！</p>

      <div id="collectionGrid" class="grid"></div>

    </section>

  </div>



  <!-- Teacher -->

  <section class="card teacher" id="teacherCard" style="display:none">

    <h2 style="margin:0 0 8px">教師モード</h2>

    <div class="row">

      <button class="btn ghost" id="switchUserBtn">ユーザー切替</button>

      <button class="btn" id="exportBtn">進捗をJSONエクスポート</button>

      <button class="btn" id="wipeBtn">このユーザーの全データ削除</button>

      <button class="btn secondary" id="changePwBtn">このユーザーのパスワード変更</button>

    </div>

    <pre id="exportBox" style="margin-top:12px;white-space:pre-wrap;word-break:break-all;background:#0b1020;color:#e6ecff;border-radius:12px;padding:12px;display:none"></pre>

  </section>

</div>



<script>

/* ================= 画像：Google Drive直リンク ================ */

const allCharacters = [

  "https://drive.google.com/uc?export=view&id=12m_FCI2-jGCBj7HkMRiF89KAqLEeZ7um",

  "https://drive.google.com/uc?export=view&id=1t-4CTjAw8ku78iI6aQZg82zphbyaJzSx",

  "https://drive.google.com/uc?export=view&id=148-SiuyH2OipZN0hqqYf8-FBbEPY8P_1",

  "https://drive.google.com/uc?export=view&id=1k8icMUbPhviCCgk6J47-VzY16INULG85",

  "https://drive.google.com/uc?export=view&id=1qbqoxhkqsflv_KoeaCt4kMXhLnpu2Wis",

  "https://drive.google.com/uc?export=view&id=17ry9Ema2PArSHv-4zrYaW_nKqK6oD1qA",

  "https://drive.google.com/uc?export=view&id=1fLgzf-xDjx2bcidnU1zhrfbVZQCSj_IG",

  "https://drive.google.com/uc?export=view&id=1FDzuAcYObFPL_q5LyrtLP6fOOI2q0GI8",

  "https://drive.google.com/uc?export=view&id=1mtaNPgux84by8y-QU9YESO3NB_OApbDW",

  "https://drive.google.com/uc?export=view&id=1kL99PFhjccY04BdmrxCdkxosPxUsabtq",

  "https://drive.google.com/uc?export=view&id=1t_RdRHSDC1g4PXjqqH_Fa0pvBWWZGuE_",

  "https://drive.google.com/uc?export=view&id=1Ve9ADY8hC9J3eWQZ84ytOQWdLJE92pMY",

  "https://drive.google.com/uc?export=view&id=1fCYZ7u9i6KWMUOti-eYgE3AhG0ayEYKk",

  "https://drive.google.com/uc?export=view&id=1kwN9Yr2oDlRcTn_P6_Us2vPPg1x_6FkQ",

  "https://drive.google.com/uc?export=view&id=1bRSdKUBiNPZEFoM5pyKTgSLi6g_Tkuw5",

  "https://drive.google.com/uc?export=view&id=1ZI9lQ7uScYH2rp3JqKbWbor2fm3DQw8M",

  "https://drive.google.com/uc?export=view&id=1z99Ako8UvPAiGUEzvTFUkfjIPh5rao99",

  "https://drive.google.com/uc?export=view&id=1nn5W-UMANpU08CcrOkCHJDl-m_F6lNj2",

  "https://drive.google.com/uc?export=view&id=1_0e9GUYLL_Vr3aPkFLbiSsBObSpFv5bp",

  "https://drive.google.com/uc?export=view&id=18DtAiqa3Ooss1NgfMiDNmhJW_U3ZVY6R",

  "https://drive.google.com/uc?export=view&id=1_3J_WNokM6NLQ1u0E-U7gcyWfHI7Yzwh",

  "https://drive.google.com/uc?export=view&id=1JBDFQQUdvYf2wgYVwtbZ1hUaTImB8PBM",

  "https://drive.google.com/uc?export=view&id=1ltDo3jLgNyyF5o-m5RtZJxKi5yRrB2JA",

  "https://drive.google.com/uc?export=view&id=12ImpwqqcxvprQf2TEW4y-_9YD2c12Jk3",

  "https://drive.google.com/uc?export=view&id=1PU2-zwMerVwFtAIBPrpWbpYvDLSMaJ1C",

  "https://drive.google.com/uc?export=view&id=1Mbr4h8nsUNzzviseyZUhQIe7Vj6Xdpao",

  "https://drive.google.com/uc?export=view&id=1p956pFZmN83mIt2D5VVtoTBurjlR2XJR",

  "https://drive.google.com/uc?export=view&id=1weZwwa9j0Qkdip5hhZuEbHccUGOug_6b",

  "https://drive.google.com/uc?export=view&id=13IffBmqFxl9sr4q3Tx22zUWgjVYHQP5b",

  "https://drive.google.com/uc?export=view&id=1Yxtii9ngfFIJKFHX8I7gUj5kNMBXh4NS",

  "https://drive.google.com/uc?export=view&id=1tlKec643oljq-q6hnttsZCmzDLFGMibZ",

  "https://drive.google.com/uc?export=view&id=1OAllQQjTA9jtDAW_2qTM8Q0GnlWif8Wf",

  "https://drive.google.com/uc?export=view&id=1zVPXfi9ZVmoxvT7kxJaN-mlPcdLkHdXH",

  "https://drive.google.com/uc?export=view&id=15_ugE6oappJ9nSbUa2VCooGTXXnlWXRc",

  "https://drive.google.com/uc?export=view&id=1bIoaJvkS4C_vxHSD_e2pQ1UU5qtRr5p-",

  "https://drive.google.com/uc?export=view&id=1-3BCNFwZWatqwxobHPwDjHzH7Jt-xZvp",

  "https://drive.google.com/uc?export=view&id=17_Aiyq09FzIHBoZYjiiK4dRKsqmzX2w4",

  "https://drive.google.com/uc?export=view&id=1ul2gNCCm3oKZSc8kP4Y9wioUP83XqVDa",

  "https://drive.google.com/uc?export=view&id=1IgGcACVDSQ2SUvcc5wsZoTgCwVNmk3tJ"

];



/* ================== 問題データ（全単元） ================ */

const units = {

  "1-1 線対称": [

    { q: "線対称の図形で、対称の軸は何本ありますか？正方形の場合", options: ["1","2","3","4"], answer: 4 },

    { q: "線対称な図形はどれですか？", options: ["三角定規","L字型","台形","五角形"], answer: 1 },

    { q: "線対称の図形でないものはどれですか？", options: ["円","二等辺三角形","長方形","不等辺三角形"], answer: 4 },

    { q: "ひし形の対称の軸は何本ですか？", options: ["1","2","3","4"], answer: 2 },

    { q: "線対称の図形は鏡に映すとどうなりますか？", options: ["同じ形になる","形が変わる","反転して違う形になる","大きくなる"], answer: 1 }

  ],

  "1-2 点対称": [

    { q: "点対称な図形はどれですか？", options: ["正方形","円","長方形","ひし形"], answer: 4 },

    { q: "アルファベットで点対称な文字はどれですか？", options: ["A","B","C","H"], answer: 4 },

    { q: "点対称な図形は、180度回転させるとどうなりますか？", options: ["同じ形になる","逆さまになるが形は同じ","全く違う形になる","大きくなる"], answer: 2 },

    { q: "点対称でない図形はどれですか？", options: ["円","五角形","長方形","正三角形"], answer: 4 },

    { q: "正六角形は点対称ですか？", options: ["はい","いいえ","場合による","わからない"], answer: 1 }

  ],

  "2-1 文字を使った式の表し方": [

    { q: "x個のリンゴがあり、1個100円なら代金は？", options: ["100x","x+100","100+x","x-100"], answer: 1 },

    { q: "縦xcm、横ycmの長方形の面積は？", options: ["x+y","xy","x-y","2x+2y"], answer: 2 },

    { q: "1個a円のお菓子をb個買う代金は？", options: ["a+b","a-b","ab","a/b"], answer: 3 },

    { q: "m分を秒にすると？", options: ["60m","m/60","m+60","m-60"], answer: 1 },

    { q: "縦x、横yの長方形の周の長さは？", options: ["x+y","2x+2y","xy","x-y"], answer: 2 }

  ],

  "2-2 文字を使った式の計算": [

    { q: "3x+5xは？", options: ["8x","15x","x^8","2x"], answer: 1 },

    { q: "2x-7xは？", options: ["-5x","5x","x","7x"], answer: 1 },

    { q: "x×xは？", options: ["2x","x^2","x^3","x/2"], answer: 2 },

    { q: "4x÷2は？", options: ["2x","x","8x","x/2"], answer: 1 },

    { q: "5x+3yはこれ以上簡単にできる？", options: ["できる","できない","場合による","わからない"], answer: 2 }

  ],

  "3-1 分数×整数": [

    { q: "3/4×8は？", options: ["6","8","9","10"], answer: 1 },

    { q: "2/5×10は？", options: ["2","4","6","8"], answer: 2 },

    { q: "7/8×16は？", options: ["12","14","15","13"], answer: 2 },

    { q: "5/6×12は？", options: ["8","10","12","14"], answer: 2 },

    { q: "4/9×27は？", options: ["10","12","14","16"], answer: 2 }

  ],

  "3-2 分数÷整数": [

    { q: "3/4÷2は？", options: ["3/8","3/6","3/2","6/4"], answer: 1 },

    { q: "5/6÷5は？", options: ["1/6","5/30","5/11","6/5"], answer: 1 },

    { q: "7/8÷7は？", options: ["1/8","7/15","1/16","15/7"], answer: 3 },

    { q: "2/3÷4は？", options: ["2/12","1/6","2/7","3/8"], answer: 2 },

    { q: "9/10÷3は？", options: ["3/10","3/13","1/3","10/27"], answer: 1 }

  ],

  "3-3 分数×分数": [

    { q: "2/3×3/4は？", options: ["1/2","2/7","3/8","1/3"], answer: 1 },

    { q: "5/6×2/5は？", options: ["1/3","2/3","5/12","1/6"], answer: 1 },

    { q: "7/8×4/7は？", options: ["1/2","4/8","1/3","2/7"], answer: 1 },

    { q: "3/5×5/9は？", options: ["1/3","1/2","5/15","3/14"], answer: 1 },

    { q: "4/7×14/5は？", options: ["8/5","4/5","2/7","7/8"], answer: 1 }

  ],

  "4-1 分数÷分数": [

    { q: "2/3÷4/5は？", options: ["5/6","6/5","3/5","5/3"], answer: 1 },

    { q: "3/4÷2/7は？", options: ["21/8","8/21","7/8","3/14"], answer: 1 },

    { q: "5/6÷5/12は？", options: ["2","1/2","5/10","12/5"], answer: 1 },

    { q: "7/8÷1/4は？", options: ["7/2","8/7","7/32","1/2"], answer: 1 },

    { q: "9/10÷3/5は？", options: ["3/2","2/3","5/6","10/27"], answer: 1 }

  ],

  "4-2 分数の倍": [

    { q: "3/4の2倍は？", options: ["3/2","6/4","1/2","4/3"], answer: 1 },

    { q: "5/6の3倍は？", options: ["15/6","5/2","3/5","6/5"], answer: 1 },

    { q: "2/5の4倍は？", options: ["8/5","5/8","4/5","2/8"], answer: 1 },

    { q: "7/8の0.5倍は？", options: ["7/16","16/7","1/2","14/8"], answer: 1 },

    { q: "9/10の1.5倍は？", options: ["27/20","20/27","3/5","5/3"], answer: 1 }

  ],

  "5-1 比の意味": [

    { q: "3:4は次のどれと等しいですか？", options: ["6:8","4:5","9:10","12:13"], answer: 1 },

    { q: "2:5と等しい比は？", options: ["4:10","5:12","3:5","7:9"], answer: 1 },

    { q: "5:8と等しい比は？", options: ["10:16","8:13","15:24","1:2"], answer: 1 },

    { q: "1:3と等しい比は？", options: ["2:6","3:9","4:12","全部"], answer: 4 },

    { q: "6:9を簡単にすると？", options: ["2:3","3:4","4:5","3:5"], answer: 1 }

  ],

  "5-2 比の値の計算": [

    { q: "8:12の値は？", options: ["2/3","3/2","4/6","6/4"], answer: 1 },

    { q: "5:20の値は？", options: ["1/4","4","5","20"], answer: 1 },

    { q: "9:15の値は？", options: ["3/5","5/3","2/3","1/2"], answer: 1 },

    { q: "7:14の値は？", options: ["1/2","2","7/14","14/7"], answer: 1 },

    { q: "12:18の値は？", options: ["2/3","3/2","4/6","6/4"], answer: 1 }

  ],

  "5-3 比の利用": [

    { q: "3:5の比で8個のボールを分けます。少ない方は何個ですか？", options: ["3","4","5","8"], answer: 2 },

    { q: "2:3の比で20個の飴を分けます。多い方は何個ですか？", options: ["8","10","12","15"], answer: 3 },

    { q: "4:1の比で10Lのジュースを分けます。少ない方は何Lですか？", options: ["2","4","6","8"], answer: 1 },

    { q: "5:7の比で24mのリボンを分けます。多い方は何mですか？", options: ["10","12","14","16"], answer: 3 },

    { q: "1:4の比で25枚のカードを分けます。多い方は何枚ですか？", options: ["4","5","20","25"], answer: 3 }

  ],

  "6-1 拡大図": [

    { q: "長さ4cmの線分を、2倍に拡大すると長さは何cmになりますか？", options: ["6","8","10","12"], answer: 2 },

    { q: "三角形の各辺の長さが2cm, 3cm, 4cmのとき、1.5倍に拡大した三角形の最も長い辺は何cmですか？", options: ["5","5.5","6","6.5"], answer: 3 },

    { q: "正方形の一辺が5cmの図形を、3倍に拡大したときの一辺の長さは何cmですか？", options: ["10","12","15","20"], answer: 3 },

    { q: "半径3cmの円を2倍に拡大したときの半径は何cmですか？", options: ["5","6","7","8"], answer: 4 },

    { q: "長さ9cmの線分を、0.5倍に縮小すると長さは何cmになりますか？", options: ["4.5","5","6","7"], answer: 1 }

  ],

  "6-2 縮図": [

    { q: "実際の長さ20mを、1/100の縮尺で表すと何cmになりますか？", options: ["20","200","2","0.2"], answer: 2 },

    { q: "地図上で5cmの距離が、実際には1kmのときの縮尺はどれですか？", options: ["1/20000","1/50000","1/10000","1/25000"], answer: 2 },

    { q: "実際の距離300mを、1/500の縮尺で表すと図上では何cmになりますか？", options: ["60","6","0.6","600"], answer: 1 },

    { q: "地図上で12cmの距離が、実際には480mであるとき、縮尺はどれですか？", options: ["1/40","1/400","1/4000","1/4800"], answer: 3 },

    { q: "実際の長さ8mを1/200の縮尺で描くと、図の長さは何cmになりますか？", options: ["40","4","0.4","400"], answer: 4 }

  ],

  "7-1平均値と中央値": [

    { q: "5, 8, 10 の平均値は？", options: ["7","8","9","10"], answer: 1 },

    { q: "3, 5, 7 の中央値は？", options: ["3","5","7","6"], answer: 2 },

    { q: "4, 6, 8, 10 の平均値は？", options: ["7","8","6","9"], answer: 1 },

    { q: "1, 3, 5, 7, 9 の中央値は？", options: ["3","5","7","4"], answer: 2 },

    { q: "2, 4, 6, 8 の中央値は？", options: ["4","5","6","7"], answer: 2 }

  ],

  "7-2度数分布表と柱状グラフ": [

    { q: "度数分布表で最も多い区間を何と呼ぶ？", options: ["平均","最頻値","中央値","範囲"], answer: 2 },

    { q: "柱状グラフはどんなデータに向いている？", options: ["時間の変化","割合の比較","数値の分布","位置の変化"], answer: 3 },

    { q: "度数分布表で階級の幅が大きいほど？", options: ["細かく見える","大まかになる","変わらない","不明"], answer: 2 },

    { q: "柱状グラフの縦軸は何を表す？", options: ["度数","割合","時間","階級"], answer: 1 },

    { q: "帯グラフは何を表すのに便利？", options: ["時間","割合","位置","順序"], answer: 2 }

  ],

  "7-3折れ線グラフと帯グラフ": [

    { q: "折れ線グラフは何を表す？", options: ["時間の変化","割合の比較","分布","順序"], answer: 1 },

    { q: "帯グラフの全体の長さは何を表す？", options: ["100%","合計","最大値","中央値"], answer: 1 },

    { q: "折れ線グラフで点を結ぶ線は何を示す？", options: ["変化の様子","割合","平均","範囲"], answer: 1 },

    { q: "帯グラフで色分けされている部分は何を表す？", options: ["項目別の割合","時間の変化","平均","階級"], answer: 1 },

    { q: "折れ線グラフと柱状グラフを組み合わせたものは？", options: ["複合グラフ","帯グラフ","散布図","ヒストグラム"], answer: 1 }

  ],

  "8-1円の面積の求め方": [

    { q: "半径5cmの円の面積は？(π=3.14)", options: ["78.5","31.4","25","62.8"], answer: 1 },

    { q: "半径10cmの円の面積は？(π=3.14)", options: ["314","157","100","62.8"], answer: 1 },

    { q: "直径8cmの円の半径は？", options: ["4","8","16","2"], answer: 1 },

    { q: "円の面積の公式は？", options: ["πr²","2πr","r²","πd"], answer: 1 },

    { q: "半径3cmの円の面積は？(π=3.14)", options: ["28.26","18.84","9","31.4"], answer: 1 }

  ],

  "8-2半円・扇形の面積": [

    { q: "半径6cmの半円の面積は？(π=3.14)", options: ["56.52","113.04","18.84","28.26"], answer: 1 },

    { q: "半径4cm、中心角90°の扇形の面積は？(π=3.14)", options: ["12.56","25.12","50.24","6.28"], answer: 1 },

    { q: "半径5cm、中心角180°の扇形は何の形の半分？", options: ["円","長方形","三角形","楕円"], answer: 1 },

    { q: "半円の面積を求めるには円の面積をどうする？", options: ["2倍","半分","3倍","4倍"], answer: 2 },

    { q: "扇形の面積の公式は？", options: ["πr²×中心角/360","2πr","πd","r²"], answer: 1 }

  ],

  "9-1角柱の体積": [

    { q: "底面積20cm²、高さ5cmの角柱の体積は？", options: ["100","25","200","10"], answer: 1 },

    { q: "底面が長方形の角柱の体積は底面積×何？", options: ["底辺","高さ","幅","奥行き"], answer: 2 },

    { q: "底面積50cm²、高さ2cmの角柱の体積は？", options: ["100","25","150","200"], answer: 1 },

    { q: "体積の単位は？", options: ["cm²","cm³","cm","m"], answer: 2 },

    { q: "底面積10cm²、高さ10cmの角柱の体積は？", options: ["100","10","1","1000"], answer: 1 }

  ],

  "9-2円柱の体積": [

    { q: "底面積30cm²、高さ5cmの円柱の体積は？", options: ["150","35","300","15"], answer: 1 },

    { q: "円柱の体積の公式は？", options: ["底面積×高さ","2πr","πr²","高さ×周の長さ"], answer: 1 },

    { q: "半径3cm、高さ10cmの円柱の体積は？(π=3.14)", options: ["282.6","94.2","188.4","565.2"], answer: 1 },

    { q: "体積の単位は？", options: ["cm³","cm²","cm","m²"], answer: 1 },

    { q: "底面積15cm²、高さ4cmの円柱の体積は？", options: ["60","45","30","75"], answer: 1 }

  ],

  "10-1面積のおよその値": [

    { q: "長方形の面積をおよそ求めるとき、1辺が2.9mなら何mとして計算する？", options: ["2m","3m","4m","2.5m"], answer: 2 },

    { q: "半径3.2cmの円の面積をおよそ求めるには半径を何cmとする？", options: ["3cm","3.5cm","4cm","2cm"], answer: 1 },

    { q: "1.48mをおよその値にすると？", options: ["1m","1.5m","2m","1.4m"], answer: 2 },

    { q: "1.76mを四捨五入して整数にすると？", options: ["1m","2m","3m","1.5m"], answer: 2 },

    { q: "3.14をおよそ3とするのはどんなとき？", options: ["概算のとき","正確な計算のとき","面積を出すとき","誤差を出すとき"], answer: 1 }

  ],

  "10-2体積のおよその値": [

    { q: "高さが4.9mの円柱の体積をおよそ求めるとき、高さを何mとする？", options: ["4m","5m","6m","4.5m"], answer: 2 },

    { q: "半径2.6mの円柱の体積をおよそ求めるとき、半径を何mとする？", options: ["2m","3m","2.5m","2.8m"], answer: 2 },

    { q: "6.4mを四捨五入して整数にすると？", options: ["6m","7m","5m","8m"], answer: 2 },

    { q: "3.2mをおよその値にすると？", options: ["3m","4m","2m","3.5m"], answer: 1 },

    { q: "体積の概算をする理由は？", options: ["計算を簡単にするため","正確にするため","測定のため","実験のため"], answer: 1 }

  ],

  "11-1比例の意味とグラフ": [

    { q: "比例の式は y=□x で表される。□に入るのは？", options: ["比例定数","割合","速度","比"], answer: 1 },

    { q: "xが2倍になるとyも2倍になるのは？", options: ["比例","反比例","等差数列","比例反比例"], answer: 1 },

    { q: "比例のグラフはどんな形？", options: ["直線","曲線","折れ線","放物線"], answer: 1 },

    { q: "比例のグラフは原点を通る？", options: ["通る","通らない","場合による","わからない"], answer: 1 },

    { q: "y=3xのとき、x=4ならyは？", options: ["12","7","8","3"], answer: 1 }

  ],

  "11-2反比例の意味とグラフ": [

    { q: "反比例の式は xy=□ で表される。□に入るのは？", options: ["定数","割合","速度","比"], answer: 1 },

    { q: "xが2倍になるとyは？", options: ["半分になる","2倍になる","変わらない","4倍になる"], answer: 1 },

    { q: "反比例のグラフはどんな形？", options: ["双曲線","直線","放物線","円"], answer: 1 },

    { q: "y=12/x のとき、x=3ならyは？", options: ["4","3","12","6"], answer: 1 },

    { q: "反比例のグラフは原点を通る？", options: ["通らない","通る","場合による","わからない"], answer: 1 }

  ],

  "12-1順列（並べ方）": [

    { q: "3人を並べる順列は何通り？", options: ["6","3","9","12"], answer: 1 },

    { q: "n人の順列の式は？", options: ["n!","n²","n×n","nP2"], answer: 1 },

    { q: "4人の順列は何通り？", options: ["24","12","8","16"], answer: 1 },

    { q: "順列で順番を入れ替えると別の並びとみなす？", options: ["はい","いいえ","場合による","わからない"], answer: 1 },

    { q: "5人から3人を並べるのは何通り？", options: ["60","30","10","15"], answer: 1 }

  ],

  "12-2組み合わせ": [

    { q: "5人から2人を選ぶ組み合わせは何通り？", options: ["20","10","5","15"], answer: 2 },

    { q: "組み合わせは順番を考える？", options: ["考えない","考える","場合による","わからない"], answer: 1 },

    { q: "4人から3人を選ぶ組み合わせは何通り？", options: ["4","12","6","3"], answer: 3 },

    { q: "6人から2人を選ぶ組み合わせは何通り？", options: ["12","20","10","15"], answer: 4 }

  ],

  "13-1総合問題（前半）": [

    { q: "5×(2+3)の計算結果は？", options: ["25","20","10","15"], answer: 1 },

    { q: "1/2×1/4は？", options: ["1/6","1/8","1/4","1/2"], answer: 2 },

    { q: "3:4の比を分数で表すと？", options: ["3/4","4/3","7","1"], answer: 1 },

    { q: "円の面積公式は？", options: ["半径×3.14","直径×3.14","半径×半径×3.14","半径×半径"], answer: 3 },

    { q: "底辺10cm、高さ5cmの三角形の面積は？", options: ["50","25","20","15"], answer: 2 }

  ],

  "13-2総合問題（後半）": [

    { q: "反比例のグラフの形は？", options: ["直線","放物線","双曲線","円"], answer: 3 },

    { q: "3人から2人を選ぶ組み合わせは？", options: ["6","3","9","2"], answer: 2 },

    { q: "2.8mを四捨五入して整数にすると？", options: ["3","2","4","5"], answer: 1 },

    { q: "y=5xのときx=2ならyは？", options: ["7","8","12","10"], answer: 4 },

    { q: "半径7cmの円周の長さは？(π=3.14)", options: ["43.96","49","21.98","50"], answer: 1 }

  ]

};



/* ================== 認証・保存まわり ================== */

const teacherPassword = "sensei"; // 教師モードPW（ここで変更可）

let currentUser = null;



/* ---- keys ---- */

const AUTH_NS = "quiz_v2::auth::";                       // 例）quiz_v2::auth::Taro  => {hash:"...", created:...}

const USER_KEY = "quiz_v2::user";                         // 現在ログイン中ユーザー名

const storageKey = (sub) => `quiz_v2::${currentUser}::${sub}`;

const colKey     = () => `quiz_v2::${currentUser}::collection`;

const awardedKey = (sub, idx) => `quiz_v2::${currentUser}::awarded::${sub}::${idx}`;

const authKey    = (name) => `${AUTH_NS}${name}`;



/* ---- auth helpers ---- */

async function sha256Hex(text){

  if(window.crypto?.subtle){

    const enc = new TextEncoder().encode(text);

    const buf = await crypto.subtle.digest("SHA-256", enc);

    return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,"0")).join("");

  }

  // Fallback: 簡易ハッシュ（安全性は低いがローカル用途の最終手段）

  let h = 5381; for(let i=0;i<text.length;i++){ h = ((h<<5)+h) ^ text.charCodeAt(i); }

  return ("00000000"+(h>>>0).toString(16)).slice(-8);

}



function saveUser(name){ localStorage.setItem(USER_KEY, name); }

function loadUser(){ return localStorage.getItem(USER_KEY); }

function clearUser(){ localStorage.removeItem(USER_KEY); }



/* ================== 進捗管理 ================== */

function getProgress(sub){

  const raw = localStorage.getItem(storageKey(sub));

  if(!raw) return { correct: [], cursor: 0 };

  try{ return JSON.parse(raw); }catch{ return { correct: [], cursor: 0 }; }

}

function setProgress(sub, data){ localStorage.setItem(storageKey(sub), JSON.stringify(data)); }



/* ================== コレクション ================== */

function getCollection(){

  const raw = localStorage.getItem(colKey());

  if(!raw) return [];

  try{ return JSON.parse(raw); }catch{ return []; }

}

function setCollection(arr){ localStorage.setItem(colKey(), JSON.stringify(arr)); }

function awardCharacter(){

  const current = getCollection();

  const remaining = allCharacters.filter(url => !current.includes(url));

  if(remaining.length === 0){

    return { awarded:false, url:null, message:"コンプリートおめでとう！" };

  }

  const newUrl = remaining[Math.floor(Math.random()*remaining.length)];

  current.push(newUrl);

  setCollection(current);

  return { awarded:true, url:newUrl, message:"おめでとう！新しいキャラクターをゲット！" };

}



/* ================== UI参照 ================== */

const loginCard = document.getElementById('loginCard');

const controlsCard = document.getElementById('controlsCard');

const quizCard = document.getElementById('quizCard');

const collectionCard = document.getElementById('collectionCard');

const teacherCard = document.getElementById('teacherCard');



const currentUserLabel = document.getElementById('currentUserLabel');

const unitSelect = document.getElementById('unitSelect');

const subunitSelect = document.getElementById('subunitSelect');

const qCounter = document.getElementById('qCounter');

const subunitTitle = document.getElementById('subunitTitle');

const questionText = document.getElementById('questionText');

const optionsDiv = document.getElementById('options');

const feedback = document.getElementById('feedback');

const progressText = document.getElementById('progressText');

const progressBar = document.getElementById('progressBar');



/* ================== 認証UI挙動 ================== */

document.getElementById('loginBtn').addEventListener('click', async ()=>{

  const name = (document.getElementById('nickname').value || "").trim();

  const pw = (document.getElementById('password').value || "");

  if(!name){ alert("ニックネームを入力してください"); return; }

  if(!pw){ alert("パスワードを入力してください"); return; }



  const authRaw = localStorage.getItem(authKey(name));

  const pwHash = await sha256Hex(pw);



  if(!authRaw){

    // 新規登録

    const ok = confirm(`「${name}」を新規作成します。よろしいですか？`);

    if(!ok) return;

    localStorage.setItem(authKey(name), JSON.stringify({ hash: pwHash, created: Date.now() }));

    currentUser = name; saveUser(name);

    afterLogin();

  }else{

    // 既存ユーザー → 検証

    try{

      const rec = JSON.parse(authRaw);

      if(rec.hash === pwHash){

        currentUser = name; saveUser(name);

        afterLogin();

      }else{

        alert("パスワードが違います");

      }

    }catch{

      alert("認証データの読み込みに失敗しました");

    }

  }

});



document.getElementById('logoutBtn').addEventListener('click', ()=>{

  if(confirm("ログアウトしますか？")){

    clearUser(); currentUser = null; showLogin();

  }

});



/* ================== 教師モード ================== */

document.getElementById('teacherBtn').addEventListener('click', ()=>{

  const pw = prompt("教師モードパスワードを入力してください");

  if(pw === teacherPassword){

    teacherCard.style.display = "block";

  }else if(pw !== null){

    alert("パスワードが違います");

  }

});

document.getElementById('switchUserBtn').addEventListener('click', ()=>{

  const name = prompt("切り替えるユーザー名（ニックネーム）を入力");

  if(!name) return;

  const pw = prompt(`ユーザー「${name}」のパスワードを入力`);

  if(pw===null) return;

  // 認証チェック

  sha256Hex(pw).then(hash=>{

    const raw = localStorage.getItem(authKey(name));

    if(!raw){ alert("そのユーザーは登録されていません"); return; }

    try{

      const rec = JSON.parse(raw);

      if(rec.hash === hash){

        currentUser = name.trim(); saveUser(currentUser);

        startApp();

        alert(`ユーザーを「${currentUser}」に切り替えました`);

      }else{

        alert("パスワードが違います");

      }

    }catch{ alert("認証データの読み込みに失敗しました"); }

  });

});

document.getElementById('wipeBtn').addEventListener('click', ()=>{

  if(!currentUser){ alert("ユーザー未選択"); return; }

  if(!confirm(`${currentUser} の全データ（進捗・コレクション）を削除します。よろしいですか？`)) return;

  Object.keys(localStorage).forEach(k=>{

    if(k.startsWith(`quiz_v2::${currentUser}::`)) localStorage.removeItem(k);

  });

  alert("学習データを削除しました（認証は残しています）");

  startApp();

});

document.getElementById('exportBtn').addEventListener('click', ()=>{

  if(!currentUser){ alert("ユーザー未選択"); return; }

  const dump = {};

  Object.keys(localStorage).forEach(k=>{

    if(k.startsWith(`quiz_v2::${currentUser}::`)){

      dump[k] = localStorage.getItem(k);

    }

  });

  const pre = document.getElementById('exportBox');

  pre.textContent = JSON.stringify(dump, null, 2);

  pre.style.display = "block";

});

document.getElementById('changePwBtn').addEventListener('click', async ()=>{

  if(!currentUser){ alert("ユーザー未選択"); return; }

  const oldPw = prompt("現在のパスワードを入力");

  if(oldPw===null) return;

  const raw = localStorage.getItem(authKey(currentUser));

  if(!raw){ alert("認証データが見つかりません"); return; }

  let rec; try{ rec = JSON.parse(raw); }catch{ alert("認証データ読込失敗"); return; }

  const oldHash = await sha256Hex(oldPw);

  if(rec.hash !== oldHash){ alert("現在のパスワードが違います"); return; }

  const newPw = prompt("新しいパスワードを入力（8文字以上推奨）");

  if(newPw===null || !newPw){ alert("変更を中止しました"); return; }

  const newHash = await sha256Hex(newPw);

  localStorage.setItem(authKey(currentUser), JSON.stringify({ ...rec, hash:newHash, changed: Date.now() }));

  alert("パスワードを更新しました");

});



/* ================== 学習UI操作 ================== */

document.getElementById('showCollectionBtn').addEventListener('click', showCollection);

document.getElementById('hideCollectionBtn').addEventListener('click', ()=>{ collectionCard.style.display = "none"; });

document.getElementById('prevQ').addEventListener('click', ()=>moveQuestion(-1));

document.getElementById('nextQ').addEventListener('click', ()=>moveQuestion(1));

document.getElementById('resetSubunit').addEventListener('click', ()=>{

  const sub = subunitSelect.value;

  if(!confirm(`${sub} の進捗（正解履歴）をリセットします。よろしいですか？`)) return;

  setProgress(sub, { correct: [], cursor: 0 });

  renderQuestion();

});



/* ===== 単元 / 小単元リスト ===== */

function buildUnitMap(){

  const map = {};

  Object.keys(units).forEach(key=>{

    const unitNo = (key.split('-')[0]||"").trim();

    map[unitNo] = map[unitNo] || [];

    map[unitNo].push(key);

  });

  Object.keys(map).forEach(no=>{ map[no].sort((a,b)=> a.localeCompare(b,'ja')); });

  return map;

}



/* ===== 画面切替 ===== */

function showLogin(){

  loginCard.style.display = "block";

  controlsCard.style.display = "none";

  quizCard.style.display = "none";

  collectionCard.style.display = "none";

  teacherCard.style.display = "none";

  document.getElementById('logoutBtn').style.display = "none";

  document.getElementById('nickname').value = "";

  document.getElementById('password').value = "";

}

function afterLogin(){

  startApp();

  document.getElementById('logoutBtn').style.display = "inline-block";

}



/* ===== アプリ開始 ===== */

function startApp(){

  loginCard.style.display = "none";

  controlsCard.style.display = "block";

  quizCard.style.display = "block";

  collectionCard.style.display = "none";

  teacherCard.style.display = "none";

  currentUserLabel.textContent = currentUser || "-";



  const map = buildUnitMap();

  unitSelect.innerHTML = "";

  Object.keys(map).sort((a,b)=>Number(a)-Number(b)).forEach(no=>{

    const opt = document.createElement('option');

    opt.value = no; opt.textContent = `単元 ${no}`;

    unitSelect.appendChild(opt);

  });



  unitSelect.onchange = refreshSubunits;

  subunitSelect.onchange = ()=> renderQuestion(true);



  refreshSubunits();

  renderQuestion(true);

}



function refreshSubunits(){

  const map = buildUnitMap();

  const selUnit = unitSelect.value || Object.keys(map)[0];

  const subs = map[selUnit] || [];

  subunitSelect.innerHTML = "";

  subs.forEach(k=>{

    const opt = document.createElement('option');

    opt.value = k; opt.textContent = k;

    subunitSelect.appendChild(opt);

  });

  subunitTitle.textContent = subunitSelect.value;

}



function renderQuestion(resetCursor=false){

  const sub = subunitSelect.value;

  subunitTitle.textContent = sub;

  const data = getProgress(sub);

  const list = units[sub];

  if(!list || list.length===0){

    questionText.textContent = "この小単元には問題がありません。";

    optionsDiv.innerHTML = ""; feedback.innerHTML = "";

    return;

  }

  if(resetCursor){

    if(data.cursor < 0) data.cursor = 0;

    if(data.cursor >= list.length) data.cursor = 0;

    setProgress(sub, data);

  }

  const idx = data.cursor;

  const item = list[idx];



  qCounter.textContent = `${idx+1} / ${list.length}`;

  questionText.textContent = item.q;

  optionsDiv.innerHTML = "";

  feedback.innerHTML = "";



  const solved = data.correct.length;

  progressText.textContent = `${solved}/${list.length}`;

  progressBar.style.width = `${(solved/list.length)*100}%`;



  item.options.forEach((op, i)=>{

    const btn = document.createElement('button');

    btn.className = 'opt';

    btn.innerHTML = `<b>${i+1}.</b> ${op}`;

    btn.addEventListener('click', ()=> onAnswer(i+1));

    optionsDiv.appendChild(btn);

  });

}



function moveQuestion(delta){

  const sub = subunitSelect.value;

  const data = getProgress(sub);

  const list = units[sub];

  data.cursor += delta;

  if(data.cursor < 0) data.cursor = list.length-1;

  if(data.cursor >= list.length) data.cursor = 0;

  setProgress(sub, data);

  renderQuestion();

}



function onAnswer(choice){

  const sub = subunitSelect.value;

  const data = getProgress(sub);

  const list = units[sub];

  const idx = data.cursor;

  const correctIdx = list[idx].answer;



  [...optionsDiv.children].forEach((b,i)=>{

    b.classList.remove('correct','wrong');

    if(i+1===choice) b.classList.add(choice===correctIdx ? 'correct':'wrong');

  });



  if(choice === correctIdx){

    if(!data.correct.includes(idx)){

      data.correct.push(idx);

      setProgress(sub, data);

      const guardKey = awardedKey(sub, idx);

      if(!localStorage.getItem(guardKey)){

        localStorage.setItem(guardKey, "1");

        const res = awardCharacter();

        if(res.awarded){

          feedback.innerHTML = `<p style="color:var(--ok);font-weight:700">正解！ ${res.message}</p><img src="${res.url}" alt="new character">`;

        }else{

          feedback.innerHTML = `<p style="color:var(--ok);font-weight:700">正解！ ${res.message}</p>`;

        }

      }else{

        feedback.innerHTML = `<p style="color:var(--ok);font-weight:700">正解！（この問題は既にクリア済み）</p>`;

      }

    }else{

      feedback.innerHTML = `<p style="color:var(--ok);font-weight:700">正解！（この問題は既にクリア済み）</p>`;

    }

  }else{

    feedback.innerHTML = `<p style="color:#d33;font-weight:700">ざんねん！もう一度挑戦しよう</p>`;

  }



  const solved = getProgress(sub).correct.length;

  progressText.textContent = `${solved}/${list.length}`;

  progressBar.style.width = `${(solved/list.length)*100}%`;

}



/* ============ コレクション表示 ============ */

function showCollection(){

  const grid = document.getElementById('collectionGrid');

  grid.innerHTML = "";

  const col = getCollection();

  if(col.length===0){

    grid.innerHTML = `<p class="muted">まだキャラクターを持っていません。</p>`;

  }else{

    col.forEach(url=>{

      const img = document.createElement('img');

      img.src = url;

      grid.appendChild(img);

    });

  }

  collectionCard.style.display = "block";

}



/* ============ 起動時：自動ログイン ============ */

(async function boot(){

  const saved = loadUser();

  if(saved){

    // 自動ログインは「認証済みブラウザ」を前提（PW再入力なし）

    currentUser = saved;

    afterLogin();

  }else{

    showLogin();

  }

})();

</script>

</body>

</html>
